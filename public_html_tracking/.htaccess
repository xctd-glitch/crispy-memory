# ===================================================================
# .htaccess for Tracking Domain (qvtrk.com)
# Lighter security, optimized for high-volume traffic
# ===================================================================

# Enable Rewrite Engine
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Force HTTPS (enabled for production)
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]

    # Remove www prefix (optional)
    # RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    # RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

    # Friendly URLs (optional)
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteCond %{REQUEST_FILENAME} !-d
    # RewriteRule ^(.*)$ index.php [L,QSA]
</IfModule>

# ===================================================================
# Security: Block Access to Admin Files
# ===================================================================
# Tracking domain should NOT serve admin panel
<FilesMatch "(login|logout|dashboard|data|postback-config|env-config)\.php$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# ===================================================================
# Security: Block Access to Sensitive Files
# ===================================================================
<FilesMatch "(^\.env$|^\.htaccess$|^\.gitignore$|composer\.(json|lock)|package\.json)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# ===================================================================
# Security: Disable Directory Listing
# ===================================================================
Options -Indexes

# ===================================================================
# Security: Prevent access to backup/hidden files
# ===================================================================
<FilesMatch "(^#.*#|\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# ===================================================================
# Block Bad Bots and Scanners
# ===================================================================
<IfModule mod_rewrite.c>
    # Block known bad bots
    RewriteCond %{HTTP_USER_AGENT} (AhrefsBot|Baiduspider|BLEXBot|DotBot|MJ12bot|PetalBot|SemrushBot|YandexBot|360Spider|Alexibot|asterias|BackDoorBot|BlackWidow|BlowFish|BotALot|BuiltBotTough|Bullseye|BunnySlippers|ChinaClaw|CopyRightCheck|cosmos|Crescent|Custo|DISCo|DownloadsDemon|eCatch|EirGrabber|EmailCollector|EmailSiphon|EmailWolf|EroCrawler|ExtractorPro|EyeNetIE|FlashGet|GetRight|GetWeb!|Go!Zilla|GrabNet|Grafula|Harvest|HTTrack|humanlinks|InfoNaviRobot|JennyBot|k2spider|Kenjin.Spider|larbin|LeechFTP|LinkWalker|lwp-trivial|Mata.Hari|MegaIndex|MIIxpc|moget|NetAnts|NetSpider|NetZIP|Nutch|Octopus|PageGrabber|Papa.Foto|pavuk|psbot|RealDownload|ReGet|Rippers.0|SeaMonkey$|SiteSnagger|SmartDownload|Sucker|SuperBot|SuperHTTP|Surfbot|tAkeOut|Teleport.Pro|TheNomad|TightTwatBot|Titan|TurnitinBot|URLy.Warning|VoidEYE|WebAuto|WebBandit|WebCopier|WebFetch|WebGo.IS|WebLeacher|WebReaper|WebSauger|Website.eXtractor|Website.Quester|WebStripper|WebWhacker|WebZIP|Whacker|WWWOFFLE|Xaldon.WebSpider|Zeus) [NC]
    RewriteRule .* - [F,L]

    # Block suspicious patterns
    RewriteCond %{QUERY_STRING} (base64_encode|globals|mosconfig|proc/self/environ) [NC,OR]
    RewriteCond %{QUERY_STRING} (union.*select|select.*from|insert.*into) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ===================================================================
# PHP Settings
# ===================================================================
<IfModule mod_php8.c>
    # Error reporting (production)
    php_flag display_errors off
    php_flag display_startup_errors off
    php_value error_reporting 0

    # Error logging
    php_flag log_errors on
    php_value error_log ../storage/logs/tracking_php_error.log

    # Session settings
    php_value session.gc_maxlifetime 1800
    php_flag session.cookie_httponly on
    php_flag session.cookie_secure on
    php_value session.cookie_samesite Strict
    php_flag session.use_strict_mode on

    # Upload settings (minimal untuk tracking)
    php_value upload_max_filesize 1M
    php_value post_max_size 1M
    php_value max_execution_time 30
    php_value max_input_time 30
    php_value memory_limit 128M

    # Security
    php_flag expose_php off
    php_flag allow_url_fopen off
    php_flag allow_url_include off
    php_value open_basedir "/var/www/tracking:/tmp"
    php_admin_value disable_functions "eval,exec,passthru,shell_exec,system,proc_open,popen"
</IfModule>

# ===================================================================
# Performance: Compression
# ===================================================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# ===================================================================
# Performance: Browser Caching (minimal for API responses)
# ===================================================================
<IfModule mod_expires.c>
    ExpiresActive On

    # NO caching untuk API responses
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType text/html "access plus 0 seconds"

    # Cache static assets (if any)
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
    # NO cache untuk API responses
    <FilesMatch "\.(php)$">
        Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# ===================================================================
# CORS Headers (Tracking Domain - Permissive)
# ===================================================================
<IfModule mod_headers.c>
    # Allow from any origin (public API)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, X-API-Key"
    Header always set Access-Control-Max-Age "3600"

    # Handle preflight requests
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=204,L]
</IfModule>

# ===================================================================
# Security Headers (Optimized for tracking domain)
# ===================================================================
<IfModule mod_headers.c>
    # Remove server signature
    Header always unset Server
    Header always unset X-Powered-By

    # Basic security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS

    # CSP for tracking domain - very restrictive
    Header always set Content-Security-Policy "default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data:; connect-src 'self'; font-src 'self'; object-src 'none'; media-src 'none'; frame-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;"

    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), usb=(), accelerometer=(), gyroscope=(), magnetometer=(), payment=(), interest-cohort=()"

    # Note: Additional headers can be applied via PHP SecurityHeaders::applyTrackingHeaders()
</IfModule>

# ===================================================================
# Rate Limiting (Basic - Better to use mod_ratelimit atau fail2ban)
# ===================================================================
# Implement rate limiting di application layer (ExternalApiController.php)
# atau gunakan fail2ban dengan pattern detection

# ===================================================================
# Custom Error Pages
# ===================================================================
ErrorDocument 400 /error.php
ErrorDocument 401 /error.php
ErrorDocument 403 /error.php
ErrorDocument 404 /error.php
ErrorDocument 405 /error.php
ErrorDocument 408 /error.php
ErrorDocument 429 /error.php
ErrorDocument 500 /error.php
ErrorDocument 502 /error.php
ErrorDocument 503 /error.php
ErrorDocument 504 /error.php

# ===================================================================
# END OF TRACKING DOMAIN .htaccess
# ===================================================================
